@echo off
chcp 65001 >nul
setlocal
title üè• –í–µ—Ç–µ—Ä–∏–Ω–∞—Ä–Ω–∞—è –ö–ª–∏–Ω–∏–∫–∞ - –°–µ—Ä–≤–µ—Ä

:: ==========================================
:: –ù–ê–°–¢–†–û–ô–ö–ò
:: ==========================================
set "PORT=5000"
set "HOST=http://localhost"
set "MAIN_FILE=server.py"

:: ==========================================
:: 1. –ü–†–û–í–ï–†–ö–ê –ü–û–†–¢–ê
:: ==========================================
:: –ò—â–µ–º, –∑–∞–Ω—è—Ç –ª–∏ –ø–æ—Ä—Ç. –ï—Å–ª–∏ errorlevel –Ω–µ 0, –∑–Ω–∞—á–∏—Ç –ø–æ—Ä—Ç —Å–≤–æ–±–æ–¥–µ–Ω -> –∏–¥–µ–º –∫ –∑–∞–ø—É—Å–∫—É
netstat -ano | findstr /R /C:":%PORT% " >nul
if %errorlevel% NEQ 0 goto :RUN_SERVER

:: –ï—Å–ª–∏ –º—ã –∑–¥–µ—Å—å, –∑–Ω–∞—á–∏—Ç –ø–æ—Ä—Ç –∑–∞–Ω—è—Ç
echo.
echo ‚ö†  –í–ù–ò–ú–ê–ù–ò–ï: –ü–æ—Ä—Ç %PORT% —É–∂–µ –∑–∞–Ω—è—Ç!
echo    –í–æ–∑–º–æ–∂–Ω–æ, —Å–µ—Ä–≤–µ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω –≤ –¥—Ä—É–≥–æ–º –æ–∫–Ω–µ.
echo.
set /p "kill=–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–æ—Ä—Ç—É %PORT%? (y/n): "

:: –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç (–µ—Å–ª–∏ –ù–ï y, —Ç–æ –≤—ã—Ö–æ–¥–∏–º)
if /i not "%kill%"=="y" (
    echo    –û—Ç–º–µ–Ω–∞ –∑–∞–ø—É—Å–∫–∞.
    pause
    exit /b
)

:: –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
echo.
echo    [KILL] –ó–∞–≤–µ—Ä—à–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã...
for /f "tokens=5" %%a in ('netstat -ano ^| findstr /R /C:":%PORT% "') do taskkill /F /PID %%a >nul
echo    [OK] –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫...

:RUN_SERVER
:: ==========================================
:: 2. –ü–û–ò–°–ö –í–ò–†–¢–£–ê–õ–¨–ù–û–ì–û –û–ö–†–£–ñ–ï–ù–ò–Ø
:: ==========================================
if exist "venv\Scripts\activate.bat" (
    echo [INFO] –ù–∞–π–¥–µ–Ω venv. –ê–∫—Ç–∏–≤–∞—Ü–∏—è...
    call venv\Scripts\activate.bat
) else if exist ".venv\Scripts\activate.bat" (
    echo [INFO] –ù–∞–π–¥–µ–Ω .venv. –ê–∫—Ç–∏–≤–∞—Ü–∏—è...
    call .venv\Scripts\activate.bat
) else (
    echo [INFO] –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π Python.
)

:: ==========================================
:: 3. –ó–ê–ü–£–°–ö –ë–†–ê–£–ó–ï–†–ê –ò –°–ï–†–í–ï–†–ê
:: ==========================================
:: –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ—Ç–∫—Ä—ã—Ç–∏—è –±—Ä–∞—É–∑–µ—Ä–∞ –≤ —Ñ–æ–Ω–µ
start /b cmd /c "timeout /nobreak /t 3 >nul & start %HOST%:%PORT%"

echo.
echo [START] –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä...
echo [HINT]  –ß—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä, –Ω–∞–∂–º–∏—Ç–µ Ctrl+C –∏–ª–∏ –∑–∞–∫—Ä–æ–π—Ç–µ –æ–∫–Ω–æ.
echo.

:: –ó–∞–ø—É—Å–∫ Python
python %MAIN_FILE%

echo.
echo [STOP] –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
pause